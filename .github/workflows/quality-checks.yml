name: Quality Checks & Security

on:
  push:
    branches: [ main, sketch-wip ]
  pull_request:
    branches: [ main ]

jobs:
  code-quality:
    name: Code Quality & Hygiene
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
      
    - name: Setup Ruby
      uses: ruby/setup-ruby@v1
      with:
        ruby-version: '2.6'
        bundler-cache: false
        
    - name: Check Ruby syntax
      run: |
        find . -name "*.rb" \( -path "*/+/*" -o -path "*/.git/*" -o -path "*/vendor/*" \) -prune -o -type f -print0 | xargs -0 -r ruby -c
        
    - name: Test hygiene script functionality
      run: |
        if [ -f "hygiene_simple_test.sh" ]; then
          chmod +x hygiene_simple_test.sh
          ./hygiene_simple_test.sh
        fi
        
    - name: Test multiple comments feature
      run: |
        if [ -f "test_smile_multiple_comments_simple.rb" ]; then
          ruby test_smile_multiple_comments_simple.rb
        fi
        
    - name: Test aggregated reviews schema
      run: |
        if [ -f "test_aggregated_reviews_schema.rb" ]; then
          ruby test_aggregated_reviews_schema.rb
        fi

  security-scan:
    name: Security Scanning
    runs-on: ubuntu-latest
    permissions:
      security-events: write
      actions: read
      contents: read
    steps:
    - uses: actions/checkout@v4
      
    - name: Run GitLeaks
      uses: gitleaks/gitleaks-action@v2
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        GITLEAKS_LICENSE: ${{ secrets.GITLEAKS_LICENSE }}
      with:
        config-path: .gitleaks.toml
        
    - name: Run Semgrep
      uses: semgrep/semgrep-action@v1
      with:
        config: >-
          p/security-audit
          p/secrets
          p/owasp-top-ten
      env:
        SEMGREP_RULES: p/security-audit
        SEMGREP_BASELINE_REF: main
        # Respect .semgrepignore
      continue-on-error: true
        
    - name: Show files that will be scanned by Trivy
      run: |
        echo "ðŸ“ Files and directories that will be scanned:"
        find . -type f \( -name "*.rb" -o -name "*.yml" -o -name "*.yaml" -o -name "*.gemfile" -o -name "Gemfile*" \) \
          ! -path "./+/*" ! -path "./.git/*" ! -path "./vendor/*" ! -path "./tmp/*" \
          | head -10
        echo "..."
        
    - name: Run Trivy filesystem scan
      uses: aquasecurity/trivy-action@master
      with:
        scan-type: 'fs'
        scan-ref: '.'
        format: 'sarif'
        output: 'trivy-results.sarif'
        severity: 'CRITICAL,HIGH,MEDIUM'
        exit-code: '0'
      continue-on-error: true
        
    - name: Check if SARIF file exists
      id: sarif-check
      run: |
        if [ -f "trivy-results.sarif" ] && [ -s "trivy-results.sarif" ]; then
          echo "sarif_exists=true" >> $GITHUB_OUTPUT
          echo "âœ… SARIF file created successfully"
        else
          echo "sarif_exists=false" >> $GITHUB_OUTPUT
          echo "âš ï¸  SARIF file not created or empty"
        fi
        
    - name: Upload Trivy scan results to GitHub Security tab
      uses: github/codeql-action/upload-sarif@v3
      if: steps.sarif-check.outputs.sarif_exists == 'true'
      with:
        sarif_file: 'trivy-results.sarif'
      continue-on-error: true

  functionality-tests:
    name: Feature Functionality Tests
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
    
    - name: Setup Ruby
      uses: ruby/setup-ruby@v1
      with:
        ruby-version: '2.6'
        
    - name: Test Smile multiple comments feature
      run: |
        echo "ðŸ§ª Testing Smile multiple comments functionality"
        if ruby -e "require_relative 'app/models/smile.rb'; puts 'Smile model syntax: OK'" 2>/dev/null; then
          echo "âœ… Smile model syntax is valid"
        else
          echo "âŒ Smile model has syntax errors"
          exit 1
        fi
        
    - name: Test HAML templates syntax
      run: |
        echo "ðŸ§ª Testing HAML templates"
        # Basic structure check for key templates
        if [ -f "app/views/smiles/show.erb" ]; then
          if grep -q "@related_comments.each_with_index" "app/views/smiles/show.erb"; then
            echo "âœ… Multiple comments loop found in template"
          else
            echo "âŒ Multiple comments loop not found"
            exit 1
          fi
        fi
        
    - name: Test Schema.org microdata
      run: |
        echo "ðŸ§ª Testing Schema.org microdata"
        if [ -f "app/views/smiles/show.erb" ]; then
          if grep -q '"@type": "Product"' "app/views/smiles/show.erb"; then
            echo "âœ… Product schema found"
          else
            echo "âŒ Product schema not found" 
            exit 1
          fi
          
          if grep -q '"@type": "AggregateRating"' "app/views/smiles/show.erb"; then
            echo "âœ… AggregateRating schema found"
          else
            echo "âŒ AggregateRating schema not found"
            exit 1
          fi
        fi
        
  hygiene-validation:
    name: Hygiene Script Validation  
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
      
    - name: Test hygiene script
      run: |
        echo "ðŸ§¹ Testing hygiene.sh functionality"
        
        # Check script syntax
        if bash -n hygiene.sh; then
          echo "âœ… Hygiene script syntax OK"
        else
          echo "âŒ Hygiene script syntax error"
          exit 1
        fi
        
        # Check gitignore support
        if grep -q "is_ignored()" hygiene.sh; then
          echo "âœ… GitIgnore support detected"
        else
          echo "âŒ GitIgnore support missing"
          exit 1
        fi
        
        # Check set -e handling
        if grep -q "set -e" hygiene.sh && grep -q "set +e" hygiene.sh; then
          echo "âœ… Proper set -e handling detected"
        else
          echo "âŒ Improper set -e handling"
          exit 1
        fi
        
        # Test basic execution (with timeout)
        echo "# test file" > test_temp.rb
        timeout 5s ./hygiene.sh . >/dev/null 2>&1 || true
        rm -f test_temp.rb test_temp.rb.tmp
        echo "âœ… Hygiene script execution test completed"
