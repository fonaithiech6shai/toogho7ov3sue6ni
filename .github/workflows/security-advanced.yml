name: üîí Advanced Security Scanning

on:
  push:
    branches: [ main, sketch-wip ]
    paths:
      - 'app/**'
      - 'admin/**'
      - 'config/**'
      - 'lib/**'
      - 'Gemfile*'
      - '.gitleaks.toml'
      - '.github/workflows/security-advanced.yml'
  pull_request:
    branches: [ main ]
    paths:
      - 'app/**'
      - 'admin/**'
      - 'config/**'
      - 'lib/**'
      - 'Gemfile*'
  workflow_dispatch:
    inputs:
      scan_type:
        description: '–¢–∏–ø —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è'
        required: false
        default: 'all'
        type: choice
        options:
        - all
        - gitleaks
        - semgrep
        - trivy

jobs:

  advanced-security-scan:
    name: üîí –ü—Ä–æ–¥–≤–∏–Ω—É—Ç–æ–µ —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏
    runs-on: ubuntu-latest
    permissions:
      security-events: write
      actions: read
      contents: read
    steps:
    - uses: actions/checkout@v4
      
    - name: Run GitLeaks
      uses: gitleaks/gitleaks-action@v2
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      continue-on-error: true
      
    - name: Check GitLeaks results
      if: always()
      run: |
        if [ -f "results.sarif" ]; then
          echo "‚úÖ GitLeaks scan completed with results"
        else
          echo "‚ö†Ô∏è  GitLeaks scan completed without SARIF output"
        fi
        
    - name: Run Semgrep
      uses: semgrep/semgrep-action@v1
      with:
        config: >-
          p/security-audit
          p/secrets
          p/owasp-top-ten
      env:
        SEMGREP_RULES: p/security-audit
        SEMGREP_BASELINE_REF: main
        # Respect .semgrepignore
      continue-on-error: true
        
    - name: Show files that will be scanned by Trivy
      run: |
        echo "üìÅ Files and directories that will be scanned:"
        find . -type f \( -name "*.rb" -o -name "*.yml" -o -name "*.yaml" -o -name "*.gemfile" -o -name "Gemfile*" \) \
          ! -path "./+/*" ! -path "./.git/*" ! -path "./vendor/*" ! -path "./tmp/*" \
          | head -10
        echo "..."
        
    - name: Run Trivy filesystem scan
      uses: aquasecurity/trivy-action@master
      with:
        scan-type: 'fs'
        scan-ref: '.'
        format: 'sarif'
        output: 'trivy-results.sarif'
        severity: 'CRITICAL,HIGH,MEDIUM'
        exit-code: '0'
      continue-on-error: true
        
    - name: Check if SARIF file exists
      id: sarif-check
      run: |
        if [ -f "trivy-results.sarif" ] && [ -s "trivy-results.sarif" ]; then
          echo "sarif_exists=true" >> $GITHUB_OUTPUT
          echo "‚úÖ SARIF file created successfully"
        else
          echo "sarif_exists=false" >> $GITHUB_OUTPUT
          echo "‚ö†Ô∏è  SARIF file not created or empty"
        fi
        
    - name: Upload Trivy scan results to GitHub Security tab
      uses: github/codeql-action/upload-sarif@v3
      if: steps.sarif-check.outputs.sarif_exists == 'true'
      with:
        sarif_file: 'trivy-results.sarif'
      continue-on-error: true

  vulnerability-scanning:
    name: üîç –ü–æ–∏—Å–∫ —É—è–∑–≤–∏–º–æ—Å—Ç–µ–π
    runs-on: ubuntu-latest
    needs: [advanced-security-scan]
    if: always() && (github.event.inputs.scan_type == 'trivy' || github.event.inputs.scan_type == 'all' || github.event.inputs.scan_type == '')
    
    steps:
    - uses: actions/checkout@v4
      
    - name: üîç –ü–æ–∏—Å–∫ —É—è–∑–≤–∏–º–æ—Å—Ç–µ–π –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç—è—Ö
      run: |
        echo "üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π –Ω–∞ —É—è–∑–≤–∏–º–æ—Å—Ç–∏..."
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫—Ä–∏—Ç–∏—á–Ω—ã–µ –≥–µ–º—ã –Ω–∞ —É—è–∑–≤–∏–º–æ—Å—Ç–∏
        CRITICAL_GEMS=("activerecord" "mysql2" "padrino" "sidekiq" "redis")
        
        echo "üìä –ö—Ä–∏—Ç–∏—á–Ω—ã–µ –≥–µ–º—ã –¥–ª—è –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞:"
        for gem in "${CRITICAL_GEMS[@]}"; do
          if grep -q "gem ['\"]$gem['\"]" Gemfile; then
            version=$(grep "gem ['\"]$gem['\"]" Gemfile | sed "s/.*['\"]$gem['\"][[:space:]]*,[[:space:]]*['\"]//' | sed "s/['\"].*//")
            echo "  ‚ÑπÔ∏è  $gem: $version"
          fi
        done
        
        echo "‚ÑπÔ∏è  –î–ª—è –ø–æ–ª–Ω–æ–π –ø—Ä–æ–≤–µ—Ä–∫–∏ —É—è–∑–≤–∏–º–æ—Å—Ç–µ–π —Å–º. Trivy scan –≤—ã—à–µ"
        
  summary:
    name: üìä –°–≤–æ–¥–∫–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤
    runs-on: ubuntu-latest
    needs: [advanced-security-scan, vulnerability-scanning]
    if: always()
    
    steps:
    - name: üìä –û–±—â–∞—è —Å–≤–æ–¥–∫–∞
      run: |
        echo "## üîí –†–µ–∑—É–ª—å—Ç–∞—Ç—ã –ø—Ä–æ–¥–≤–∏–Ω—É—Ç–æ–≥–æ —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏"
        echo ""
        echo "### ‚úÖ –£—Å–ø–µ—à–Ω–æ:"
        
        if [[ "${{ needs.advanced-security-scan.result }}" == "success" ]]; then
          echo "- üîç GitLeaks: –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–µ–∫—Ä–µ—Ç–æ–≤ –≤ –∫–æ–¥–µ"
          echo "- üîç Semgrep: Static Application Security Testing"
          echo "- üîç Trivy: –ü–æ–∏—Å–∫ —É—è–∑–≤–∏–º–æ—Å—Ç–µ–π"
        fi
        
        if [[ "${{ needs.vulnerability-scanning.result }}" == "success" ]]; then
          echo "- üìä –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π"
        fi
        
        echo ""
        echo "### üîó –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è:"
        echo "- ‚ÑπÔ∏è  –û—Å–Ω–æ–≤–Ω—ã–µ —Ç–µ—Å—Ç—ã –∏ –∫–∞—á–µ—Å—Ç–≤–æ –∫–æ–¥–∞: '.github/workflows/tests.yml'"
        echo "- ‚ÑπÔ∏è  –ü—Ä–æ–¥–≤–∏–Ω—É—Ç–æ–µ —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ: '.github/workflows/security-advanced.yml'"
